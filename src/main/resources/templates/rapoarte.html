<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Rapoarte clinică</title>
    <link rel="stylesheet" href="/css/listPacients.css">
    <link rel="stylesheet" href="/css/rapoarte.css">
</head>
<body>

<header>
    <nav>
        <div class="navbar">
            <div class="container nav-container">
                <input class="checkbox" type="checkbox" id="nav-toggle"/>

                <div class="hamburger-lines">
                    <span class="line line1"></span>
                    <span class="line line2"></span>
                    <span class="line line3"></span>
                </div>

                <div class="logo">
                    <img src="/assets/logo.png" alt="ClinicaTrat Logo" class="logo-img">
                </div>

                <ul class="menu-items">
                    <li><a th:href="@{/index}" onclick="document.getElementById('nav-toggle').checked=false;">Home</a></li>
                    <li><a th:href="@{/index}" onclick="document.getElementById('nav-toggle').checked=false;">About</a></li>
                    <li><a th:href="@{/info}" onclick="document.getElementById('nav-toggle').checked=false;">Informatii</a></li>
                    <li><a th:href="@{/contact}" onclick="document.getElementById('nav-toggle').checked=false;">Contact</a></li>
                    <li><a class="active-link" th:href="@{/rapoarte}">Rapoarte</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<h1>Rapoarte clinică</h1>

<section class="charts-section">

    <h2>Dashboard salarii</h2>

    <div class="charts-grid">

        <!-- GRAFIC 1 -->
        <div class="chart-card">
            <h3>Salarii medici</h3>
            <canvas id="chartSalarii"></canvas>
        </div>

        <!-- GRAFIC 2 -->
        <div class="chart-card">
            <h3>Salariu vs număr programări</h3>
            <canvas id="chartActivitate"></canvas>
        </div>

        <div class="chart-card">
            <h3>Distribuție Venituri Medicamente</h3>
            <canvas id="chartPieMedicamente"></canvas>
        </div>

        <div class="chart-card stats-summary-card">
            <h3>Sumar Clinică</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Venit Total</span>
                    <span class="stat-value" th:text="${totalVenit} + ' RON'">0 RON</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Programări Noi</span>
                    <span class="stat-value" th:text="${nrProgramariNoi}">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Stoc Critic</span>
                    <form th:action="@{/rapoarte}" method="get" id="stocForm" style="display: flex; gap: 10px; width: 100%; align-items: center;">
                        <select name="pragStoc" onchange="this.form.submit()" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.8rem;">
                            <option value="5" th:selected="${pragSelectat == 5}">Sub 5</option>
                            <option value="10" th:selected="${pragSelectat == 10}">Sub 10</option>
                            <option value="20" th:selected="${pragSelectat == 20}">Sub 25</option>
                            <option value="35" th:selected="${pragSelectat==35}">Sub 35</option>
                            <option value="50" th:selected="${pragSelectat == 50}">Sub 50</option>
                        </select>

                        <span class="stat-value warning" th:text="${medicamenteStocMic}" style="margin-left: auto;">0</span>
                    </form>
                </div>
            </div>
        </div>
    </div>

</section>

<div class="reports-container">

    <!-- RAPORT 1 -->
    <div class="report-card">
        <div class="report-header">
            <h2>Medicii cu salariu peste medie</h2>
            <button type="button"
                    class="toggle-btn"
                    onclick="toggleReport('raport1', this)">
                Generează raport
            </button>
        </div>

        <div id="raport1" class="report-content">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Prenume</th>
                    <th>Salariu</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="m : ${mediciSalariu}">
                    <td th:text="${m.medicID}"></td>
                    <td th:text="${m.nume}"></td>
                    <td th:text="${m.prenume}"></td>
                    <td th:text="${m.salariu}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- RAPORT 2 -->
    <div class="report-card">
        <div class="report-header">
            <h2>Pacienți cu programări</h2>
            <button type="button"
                    class="toggle-btn"
                    onclick="toggleReport('raport2', this)">
                Generează raport
            </button>
        </div>

        <div id="raport2" class="report-content">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Prenume</th>
                    <th>Oraș</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${pacientiCuProgramari}">
                    <td th:text="${p.pacientID}"></td>
                    <td th:text="${p.nume}"></td>
                    <td th:text="${p.prenume}"></td>
                    <td th:text="${p.oras}"></td>

                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- RAPORT 3 -->
    <div class="report-card">
        <div class="report-header">
            <h2>Medicamente utilizate în tratamente</h2>
            <button type="button"
                    class="toggle-btn"
                    onclick="toggleReport('raport3', this)">
                Generează raport
            </button>
        </div>

        <div id="raport3" class="report-content">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Stoc</th>
                    <th>Preț</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="m : ${medicamenteFolosite}">
                    <td th:text="${m.medicamentID}"></td>
                    <td th:text="${m.nume}"></td>
                    <td th:text="${m.stoc}"></td>
                    <td th:text="${m.pret}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- RAPORT 4 -->
    <div class="report-card">
        <div class="report-header">
            <h2>Medici fără programări</h2>
            <button type="button"
                    class="toggle-btn"
                    onclick="toggleReport('raport4', this)">
                Generează raport
            </button>
        </div>

        <div id="raport4" class="report-content">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Prenume</th>
                    <th>Specializare</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="m : ${mediciFaraProgramari}">
                    <td th:text="${m.medicID}"></td>
                    <td th:text="${m.nume}"></td>
                    <td th:text="${m.prenume}"></td>
                    <td th:text="${m.specializare}"></td>
                </tr>
                </tbody>
            </table>
        </div>

    </div>
    <div class="report-card">
        <div class="report-header">
            <h2>Venituri per Medicament</h2>
            <button type="button" class="toggle-btn" onclick="toggleReport('raportVenituri', this)">
                Generează
            </button>
        </div>
        <div id="raportVenituri" class="report-content">
            <table>
                <thead>
                <tr>
                    <th>Medicament</th>
                    <th>Prescrieri</th>
                    <th>Venit (RON)</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="v : ${venituriMedicamente}">
                    <td th:text="${v['Nume']}"></td>
                    <td th:text="${v['NrPrescrieri']}"></td>
                    <td th:text="${v['VenitGenerat']} + ' RON'"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="report-card">
        <div class="report-header">
            <div style="text-align: left;">
                <h2>Cheltuieli peste medie</h2>
                <form th:action="@{/rapoarte}" method="get" style="margin-top: 10px;">
                    <input type="number"
                           name="minCheltuieli"
                           placeholder="Suma min. (RON)"
                           th:value="${minCheltuieliSelectat}">
                    <button type="submit">Filtrează</button>
                </form>
            </div>
            <button type="button"
                    class="toggle-btn"
                    onclick="toggleReport('raport5', this)">
                Generează raport
            </button>
        </div>

        <div id="raport5" class="report-content" th:style="${minCheltuieliSelectat != null ? 'display:block' : 'display:none'}">
            <table>
                <thead>
                <tr>
                    <th>Nume Pacient</th>
                    <th>Prenume Pacient</th>
                    <th>Total Cheltuit</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${pacientiCheltuieli}">
                    <td th:text="${p['Nume']}"></td>
                    <td th:text="${p['Prenume']}"></td>
                    <td th:text="${p['TotalCheltuit']} + ' RON'"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function toggleReport(id, btn) {
        const el = document.getElementById(id);
        if (!el) return;

        const hidden = el.style.display === "" || el.style.display === "none";
        el.style.display = hidden ? "block" : "none";
        btn.textContent = hidden ? "Ascunde raport" : "Genereaza raport";
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const salariiData = /*[[${salariiJoin}]]*/ [];
    /*]]>*/
    if (salariiData && salariiData.length > 0) {

        const labels = salariiData.map(s => s.Nume + " " + s.Prenume);
        const salarii = salariiData.map(s => s.Salariu);
        const programari = salariiData.map(s => s.nrProgramari);

        // GRAFIC 1 – Salarii
        new Chart(document.getElementById("chartSalarii"), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Salarii medici',
                    data: salarii,
                    backgroundColor: '#4a90e2'
                }]
            },
            options: {
                responsive: true
            }
        });

        // GRAFIC 2 – Activitate
        new Chart(document.getElementById("chartActivitate"), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Număr programări',
                    data: programari,
                    borderColor: '#e67e22',
                    backgroundColor: 'rgba(230,126,34,0.2)',
                    fill: true
                }]
            },
            options: {
                responsive: true
            }
        });
    }
    /*]]>*/
    /*<![CDATA[*/
    const venituriData = /*[[${venituriMedicamente}]]*/ [];
    /*]]>*/

    if (venituriData && venituriData.length > 0) {
        const labelsMed = venituriData.map(v => v.Nume);
        const valoriMed = venituriData.map(v => v.VenitGenerat);

        new Chart(document.getElementById("chartPieMedicamente"), {
            type: 'pie', // Tipul de grafic: Plăcintă
            data: {
                labels: labelsMed,
                datasets: [{
                    data: valoriMed,
                    backgroundColor: [
                        '#4a90e2', '#e67e22', '#2ecc71', '#e74c3c', '#9b59b6', '#f1c40f'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom' // Legenda să fie sub cerc
                    }
                }
            }
        });
    }
</script>

</body>
</html>
